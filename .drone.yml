---
kind: pipeline
name: querqy-clj
type: docker
workspace:
  path: /root

steps:
- name: cache-deps
  image: clojure:openjdk-17-lein
  commands:
  - lein deps

- name: unit-test
  image: clojure:openjdk-17-lein
  depends_on:
  - cache-deps
  commands:
  - lein test :unit

- name: integration-test
  image: clojure:openjdk-17-lein
  depends_on:
  - cache-deps
  commands:
  - lein test :integration

- name: cljfmt
  image: clojure:openjdk-17-lein
  failure: ignore
  depends_on:
  - cache-deps
  commands:
  - lein cljfmt check

- name: lint
  image: clojure:openjdk-17-lein
  failure: ignore
  depends_on:
  - cache-deps
  commands:
  - lein clj-kondo --lint src test

- name: publish
  image: clojure:openjdk-17-lein
  when:
    event: [ push, tag ]
    branch: [ main ]
  depends_on:
  - unit-test
  - integration-test
  - cljfmt
  - lint
  environment:
    ARTIFACTORY_PASSWORD:
      from_secret: artifactory_password
    ARTIFACTORY_USERNAME:
      from_secret: artifactory_username
  commands:
  - lein deploy
